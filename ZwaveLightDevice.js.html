

<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
      ZwaveLightDevice.js - Documentation
  </title>

  <link href="https://www.braintreepayments.com/images/favicon-ccda0b14.png" rel="icon" type="image/png">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

  <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
  <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
  

  

  <!-- start Mixpanel -->
  <script type="text/javascript">(function(e,a){if(!a.__SV){var b=window;try{var c,l,i,j=b.location,g=j.hash;c=function(a,b){return(l=a.match(RegExp(b+"=([^&]*)")))?l[1]:null};g&&c(g,"state")&&(i=JSON.parse(decodeURIComponent(c(g,"state"))),"mpeditor"===i.action&&(b.sessionStorage.setItem("_mpcehash",g),history.replaceState(i.desiredHash||"",e.title,j.pathname+j.search)))}catch(m){}var k,h;window.mixpanel=a;a._i=[];a.init=function(b,c,f){function e(b,a){var c=a.split(".");2==c.length&&(b=b[c[0]],a=c[1]);b[a]=function(){b.push([a].concat(Array.prototype.slice.call(arguments,
  0)))}}var d=a;"undefined"!==typeof f?d=a[f]=[]:f="mixpanel";d.people=d.people||[];d.toString=function(b){var a="mixpanel";"mixpanel"!==f&&(a+="."+f);b||(a+=" (stub)");return a};d.people.toString=function(){return d.toString(1)+".people (stub)"};k="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config reset people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
  for(h=0;h<k.length;h++)e(d,k[h]);a._i.push([b,c,f])};a.__SV=1.2;b=e.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";c=e.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c)}})(document,window.mixpanel||[]);
  mixpanel.init("1919205b2da72e4da3b9b6639b444d59");</script>
  <!-- end Mixpanel -->
</head>

<body>
  <svg style="display: none;">
    <defs>
      <symbol id="linkIcon" fill="#706d77" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
          <path d="M0 0h24v24H0z" fill="none"/>
          <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/>
      </symbol>
    </defs>
  </svg>

  <input type="checkbox" id="nav-trigger" class="nav-trigger" />
  <label for="nav-trigger" class="navicon-button x">
    <div class="navicon"></div>
  </label>

  <label for="nav-trigger" class="overlay"></label>

  <div class="top-nav-wrapper">
    <ul>
      <li >
        <a href="index.html">
          
            <svg fill="#6D6D6D" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              <path d="M0 0h24v24H0z" fill="none"/>
            </svg>
          
          
        </a>
      </li>

      

    </ul>
  </div>

  <nav>
    <h3 class="reference-title">
      documentation homey-zwavedriver
    </h3>

    

    <h3>Classes</h3><ul><li id="ZwaveDevice-nav"><a href="ZwaveDevice.html">ZwaveDevice</a><ul class='methods'><li data-type="method" id="ZwaveDevice-_hasProp-nav"><a href="ZwaveDevice.html#_hasProp">_hasProp</a></li><li data-type="method" id="ZwaveDevice-configurationGet-nav"><a href="ZwaveDevice.html#configurationGet">configurationGet</a></li><li data-type="method" id="ZwaveDevice-configurationSet-nav"><a href="ZwaveDevice.html#configurationSet">configurationSet</a></li><li data-type="method" id="ZwaveDevice-disableDebug-nav"><a href="ZwaveDevice.html#disableDebug">disableDebug</a></li><li data-type="method" id="ZwaveDevice-enableDebug-nav"><a href="ZwaveDevice.html#enableDebug">enableDebug</a></li><li data-type="method" id="ZwaveDevice-executeCapabilitySetCommand-nav"><a href="ZwaveDevice.html#executeCapabilitySetCommand">executeCapabilitySetCommand</a></li><li data-type="method" id="ZwaveDevice-getCommandClass-nav"><a href="ZwaveDevice.html#getCommandClass">getCommandClass</a></li><li data-type="method" id="ZwaveDevice-getManifestSetting-nav"><a href="ZwaveDevice.html#getManifestSetting">getManifestSetting</a></li><li data-type="method" id="ZwaveDevice-getManifestSettings-nav"><a href="ZwaveDevice.html#getManifestSettings">getManifestSettings</a></li><li data-type="method" id="ZwaveDevice-getMultiChannelNodeIdsByDeviceClassGeneric-nav"><a href="ZwaveDevice.html#getMultiChannelNodeIdsByDeviceClassGeneric">getMultiChannelNodeIdsByDeviceClassGeneric</a></li><li data-type="method" id="ZwaveDevice-hasCommandClass-nav"><a href="ZwaveDevice.html#hasCommandClass">hasCommandClass</a></li><li data-type="method" id="ZwaveDevice-meterReset-nav"><a href="ZwaveDevice.html#meterReset">meterReset</a></li><li data-type="method" id="ZwaveDevice-onDeleted-nav"><a href="ZwaveDevice.html#onDeleted">onDeleted</a></li><li data-type="method" id="ZwaveDevice-onMeshInit-nav"><a href="ZwaveDevice.html#onMeshInit">onMeshInit</a></li><li data-type="method" id="ZwaveDevice-onNodeInit-nav"><a href="ZwaveDevice.html#onNodeInit">onNodeInit</a></li><li data-type="method" id="ZwaveDevice-onSettings-nav"><a href="ZwaveDevice.html#onSettings">onSettings</a></li><li data-type="method" id="ZwaveDevice-printNode-nav"><a href="ZwaveDevice.html#printNode">printNode</a></li><li data-type="method" id="ZwaveDevice-printNodeSummary-nav"><a href="ZwaveDevice.html#printNodeSummary">printNodeSummary</a></li><li data-type="method" id="ZwaveDevice-refreshCapabilityValue-nav"><a href="ZwaveDevice.html#refreshCapabilityValue">refreshCapabilityValue</a></li><li data-type="method" id="ZwaveDevice-registerCapability-nav"><a href="ZwaveDevice.html#registerCapability">registerCapability</a></li><li data-type="method" id="ZwaveDevice-registerMultiChannelReportListener-nav"><a href="ZwaveDevice.html#registerMultiChannelReportListener">registerMultiChannelReportListener</a></li><li data-type="method" id="ZwaveDevice-registerReportListener-nav"><a href="ZwaveDevice.html#registerReportListener">registerReportListener</a></li><li data-type="method" id="ZwaveDevice-registerSetting-nav"><a href="ZwaveDevice.html#registerSetting">registerSetting</a></li></ul></li><li id="ZwaveLightDevice-nav"><a href="ZwaveLightDevice.html">ZwaveLightDevice</a><ul class='methods'><li data-type="method" id="ZwaveLightDevice-_hasProp-nav"><a href="ZwaveLightDevice.html#_hasProp">_hasProp</a></li><li data-type="method" id="ZwaveLightDevice-configurationGet-nav"><a href="ZwaveLightDevice.html#configurationGet">configurationGet</a></li><li data-type="method" id="ZwaveLightDevice-configurationSet-nav"><a href="ZwaveLightDevice.html#configurationSet">configurationSet</a></li><li data-type="method" id="ZwaveLightDevice-disableDebug-nav"><a href="ZwaveLightDevice.html#disableDebug">disableDebug</a></li><li data-type="method" id="ZwaveLightDevice-enableDebug-nav"><a href="ZwaveLightDevice.html#enableDebug">enableDebug</a></li><li data-type="method" id="ZwaveLightDevice-executeCapabilitySetCommand-nav"><a href="ZwaveLightDevice.html#executeCapabilitySetCommand">executeCapabilitySetCommand</a></li><li data-type="method" id="ZwaveLightDevice-getCommandClass-nav"><a href="ZwaveLightDevice.html#getCommandClass">getCommandClass</a></li><li data-type="method" id="ZwaveLightDevice-getManifestSetting-nav"><a href="ZwaveLightDevice.html#getManifestSetting">getManifestSetting</a></li><li data-type="method" id="ZwaveLightDevice-getManifestSettings-nav"><a href="ZwaveLightDevice.html#getManifestSettings">getManifestSettings</a></li><li data-type="method" id="ZwaveLightDevice-getMultiChannelNodeIdsByDeviceClassGeneric-nav"><a href="ZwaveLightDevice.html#getMultiChannelNodeIdsByDeviceClassGeneric">getMultiChannelNodeIdsByDeviceClassGeneric</a></li><li data-type="method" id="ZwaveLightDevice-hasCommandClass-nav"><a href="ZwaveLightDevice.html#hasCommandClass">hasCommandClass</a></li><li data-type="method" id="ZwaveLightDevice-meterReset-nav"><a href="ZwaveLightDevice.html#meterReset">meterReset</a></li><li data-type="method" id="ZwaveLightDevice-onDeleted-nav"><a href="ZwaveLightDevice.html#onDeleted">onDeleted</a></li><li data-type="method" id="ZwaveLightDevice-onMeshInit-nav"><a href="ZwaveLightDevice.html#onMeshInit">onMeshInit</a></li><li data-type="method" id="ZwaveLightDevice-onNodeInit-nav"><a href="ZwaveLightDevice.html#onNodeInit">onNodeInit</a></li><li data-type="method" id="ZwaveLightDevice-onSettings-nav"><a href="ZwaveLightDevice.html#onSettings">onSettings</a></li><li data-type="method" id="ZwaveLightDevice-printNode-nav"><a href="ZwaveLightDevice.html#printNode">printNode</a></li><li data-type="method" id="ZwaveLightDevice-printNodeSummary-nav"><a href="ZwaveLightDevice.html#printNodeSummary">printNodeSummary</a></li><li data-type="method" id="ZwaveLightDevice-refreshCapabilityValue-nav"><a href="ZwaveLightDevice.html#refreshCapabilityValue">refreshCapabilityValue</a></li><li data-type="method" id="ZwaveLightDevice-registerCapability-nav"><a href="ZwaveLightDevice.html#registerCapability">registerCapability</a></li><li data-type="method" id="ZwaveLightDevice-registerMultiChannelReportListener-nav"><a href="ZwaveLightDevice.html#registerMultiChannelReportListener">registerMultiChannelReportListener</a></li><li data-type="method" id="ZwaveLightDevice-registerReportListener-nav"><a href="ZwaveLightDevice.html#registerReportListener">registerReportListener</a></li><li data-type="method" id="ZwaveLightDevice-registerSetting-nav"><a href="ZwaveLightDevice.html#registerSetting">registerSetting</a></li></ul></li></ul>
  </nav>

  <div id="main">
    
      <h1 class="page-title">
        ZwaveLightDevice.js
      </h1>
    

    
      

<section>
  <article>
    <pre class="prettyprint source linenums"><code>'use strict';

const ZwaveDevice = require('./ZwaveDevice');
const Utils = require('./util');

const FACTORY_DEFAULT_COLOR_DURATION = 255;
let debounceColorMode;

/**
 * ZwaveLightDevice takes care of all commands used by XY Lighting devices
 * (COMMAND_CLASS_SWITCH_COLOR). Set the capabilitiesOptions "setOnDim" to false for the onoff
 * capability
 *
 * Duration(s) can be given for:
 * - dim (SWITCH_MULTILEVEL >= V2)
 * - light_hue (SWITCH_COLOR >= V2)
 * - light_saturation (SWITCH_COLOR >= V2)
 * - light_temperature (SWITCH_COLOR >= V2)
 *
 * @extends ZwaveDevice
 * @example
 *
 * // app.json
 * {
 *   "id": YOUR_APP_ID,
 *   ...
 *   "drivers": [
 *     {
 *      "id": "YOUR_DRIVER_ID",
 *       "capabilitiesOptions": {
 *         "onoff": {
 *           "setOnDim": false
 *         },
 *         "dim": {
 *           "opts": {
 *             "duration": true
 *           }
 *         },
 *         "light_hue": {
 *           "opts": {
 *             "duration": true
 *           }
 *         },
 *         "light_saturation": {
 *           "opts": {
 *             "duration": true
 *           }
 *         },
 *         "light_temperature": {
 *           "opts": {
 *             "duration": true
 *           }
 *         }
 *       }
 *   ]
 * }
 *
 * // device.js
 * const ZwaveLightDevice = require('homey-meshdriver').ZwaveLightDevice;
 *
 * class myDevice extends ZwaveLightDevice {
 *
 *   async onNodeInit({ node }) {
 *
 *     await super.onNodeInit({ node });
 *     // YOUR CODE COMES HERE
 *     }
 *   }
 */

class ZwaveLightDevice extends ZwaveDevice {

  onNodeInit() {
    // Check if all used capabilities are present
    if (!this.hasCapability('onoff')) {
      this.error('Missing capability: onoff'); return;
    }
    if (!this.hasCapability('dim')) {
      this.error('Missing capability: dim'); return;
    }
    if (!this.hasCapability('light_mode')) {
      this.error('Missing capability: light_mode'); return;
    }
    if (!this.hasCapability('light_hue')) {
      this.error('Missing capability: light_hue'); return;
    }
    if (!this.hasCapability('light_saturation')) {
      this.error('Missing capability: light_saturation');
      return;
    }
    if (!this.hasCapability('light_temperature')) {
      this.error('Missing capability: light_temperature');
      return;
    }

    // Register capabilities
    if (this.hasCommandClass('SWITCH_MULTILEVEL')) {
      this.registerCapability('onoff', 'SWITCH_MULTILEVEL');
      this.registerCapability('dim', 'SWITCH_MULTILEVEL');

      // If Multilevel Switch is not available fall back to basic
    } else if (this.hasCommandClass('BASIC')) {
      this.registerCapability('onoff', 'BASIC');
      this.registerCapability('dim', 'BASIC');
    }

    this.registerMultipleCapabilityListener(
      ['light_hue', 'light_saturation'],
      async (values, options) => {
        let hue;
        let saturation;

        if (typeof values.light_hue === 'number') {
          hue = values.light_hue;
        } else {
          hue = this.getCapabilityValue('light_hue');
        }
        if (typeof values.light_saturation === 'number') {
          saturation = values.light_saturation;
        } else {
          saturation = this.getCapabilityValue('light_saturation');
        }

        const value = 1; // brightness value is not determined in SWITCH_COLOR but with
        // SWITCH_MULTILEVEL, changing this throws the dim value vs real life brightness out of sync

        const rgb = Utils.convertHSVToRGB({ hue, saturation, value });

        debounceColorMode = setTimeout(() => {
          debounceColorMode = false;
        }, 200);

        let duration = null;
        if (options.hasOwnProperty('light_hue') &amp;&amp; options.light_hue.hasOwnProperty('duration')) {
          duration = options.light_hue.duration;
        }
        if (
          !duration
          &amp;&amp; options.hasOwnProperty('light_saturation')
          &amp;&amp; options.light_saturation.hasOwnProperty('duration')
        ) {
          duration = options.light_saturation.duration;
        }

        return this._sendColors({
          warm: 0,
          cold: 0,
          red: rgb.red,
          green: rgb.green,
          blue: rgb.blue,
          duration,
        });
      },
    );

    this.registerCapabilityListener(['light_temperature'], async (value, options) => {
      const warm = Math.floor(value * 255);
      const cold = Math.floor((1 - value) * 255);

      debounceColorMode = setTimeout(() => {
        debounceColorMode = false;
      }, 200);

      let duration = null;
      if (options.hasOwnProperty('duration')) duration = options.duration;

      return this._sendColors({
        warm,
        cold,
        red: 0,
        green: 0,
        blue: 0,
        duration,
      });
    });

    this.registerCapability('light_mode', 'SWITCH_COLOR', {
      set: 'SWITCH_COLOR_SET',
      setParser: (value, options) => {
        // set light_mode is always triggered with the set color/temperature flow cards, timeout
        // is needed because of homey's async nature surpassing the debounce
        setTimeout(async () => {
          if (debounceColorMode) {
            clearTimeout(debounceColorMode);
            debounceColorMode = false;
            this.setCapabilityValue('light_mode', value)
              .catch(err => this.error('Error: could not set light_mode', err));
            return;
          }

          if (value === 'color') {
            const hue = this.getCapabilityValue('light_hue') || 1;
            const saturation = this.getCapabilityValue('light_saturation') || 1;
            const _value = 1; // brightness value is not determined in SWITCH_COLOR but with
            // SWITCH_MULTILEVEL, changing this throws the dim value vs real life brightness out
            // of sync

            const rgb = Utils.convertHSVToRGB({ hue, saturation, _value });

            this._sendColors({
              warm: 0,
              cold: 0,
              red: rgb.red,
              green: rgb.green,
              blue: rgb.blue,
              duration: options.duration || null,
            }).catch(err => this.error('Error: could not send colors', err));
            return;
          }
          if (value === 'temperature') {
            const temperature = this.getCapabilityValue('light_temperature') || 1;
            const warm = temperature * 255;
            const cold = (1 - temperature) * 255;

            this._sendColors({
              warm,
              cold,
              red: 0,
              green: 0,
              blue: 0,
              duration: options.duration || null,
            }).catch(err => this.error('Error: could not send colors', err));
          }
        }, 50);
        return null;
      },
    });

    // Getting all color values during boot
    const commandClassColorSwitch = this.getCommandClass('SWITCH_COLOR');
    if (
      !(commandClassColorSwitch instanceof Error)
      &amp;&amp; typeof commandClassColorSwitch.SWITCH_COLOR_GET === 'function'
    ) {
      // Timeout mandatory for stability, often fails getting 1 (or more) value without it
      setTimeout(() => {
        // Wait for all color values to arrive
        Promise.all([
          this._getColorValue(0),
          this._getColorValue(1),
          this._getColorValue(2),
          this._getColorValue(3),
          this._getColorValue(4),
        ]).then(result => {
          if (result[0] === 0 &amp;&amp; result[1] === 0) {
            const hsv = Utils.convertRGBToHSV({
              red: result[2],
              green: result[3],
              blue: result[4],
            });

            this.setCapabilityValue('light_mode', 'color');
            this.setCapabilityValue('light_hue', hsv.hue);
            this.setCapabilityValue('light_saturation', hsv.saturation);
          } else {
            const temperature = Math.round((result[0] / 255) * 100) / 100;
            this.setCapabilityValue('light_mode', 'temperature');
            this.setCapabilityValue('light_temperature', temperature);
          }
        });
      }, 500);
    }
  }

  async _getColorValue(colorComponentID) {
    const commandClassColorSwitch = this.getCommandClass('SWITCH_COLOR');
    if (
      !(commandClassColorSwitch instanceof Error)
      &amp;&amp; typeof commandClassColorSwitch.SWITCH_COLOR_GET === 'function'
    ) {
      try {
        const result = await commandClassColorSwitch.SWITCH_COLOR_GET({
          'Color Component ID': colorComponentID,
        });
        return result &amp;&amp; typeof result.Value === 'number' ? result.Value : 0;
      } catch (err) {
        this.error(err);
        return 0;
      }
    }
    return 0;
  }

  async _sendColors({
    warm, cold, red, green, blue, duration,
  }) {
    const SwitchColorVersion = this.getCommandClass('SWITCH_COLOR').version || 1;

    let setCommand = {
      Properties1: {
        'Color Component Count': 5,
      },
      vg1: [
        {
          'Color Component ID': 0,
          Value: Math.round(warm),
        },
        {
          'Color Component ID': 1,
          Value: Math.round(cold),
        },
        {
          'Color Component ID': 2,
          Value: Math.round(red),
        },
        {
          'Color Component ID': 3,
          Value: Math.round(green),
        },
        {
          'Color Component ID': 4,
          Value: Math.round(blue),
        },
      ],
    };

    if (SwitchColorVersion > 1) {
      setCommand.duration = typeof duration !== 'number'
        ? FACTORY_DEFAULT_COLOR_DURATION
        : Utils.calculateZwaveDimDuration(duration);
    }

    // Fix broken CC_SWITCH_COLOR_V2 parser
    if (SwitchColorVersion === 2) {
      setCommand = Buffer.from([
        setCommand.Properties1['Color Component Count'],
        0,
        setCommand.vg1[0].Value,
        1,
        setCommand.vg1[1].Value,
        2,
        setCommand.vg1[2].Value,
        3,
        setCommand.vg1[3].Value,
        4,
        setCommand.vg1[4].Value,
        setCommand.duration,
      ]);
    }

    return this.node.CommandClass.COMMAND_CLASS_SWITCH_COLOR.SWITCH_COLOR_SET(setCommand);
  }

}

module.exports = ZwaveLightDevice;
</code></pre>
  </article>
</section>

    


  </div>

  <br class="clear">

  <footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a>
  </footer>

  <script src="scripts/linenumber.js"></script>
  <script src="scripts/pagelocation.js"></script>

  

</body>
</html>
